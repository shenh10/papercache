---
layout: collection
---

<div class="collection-page">
  <h1 class="page-title collection-page-title">{{ page.title }}</h1>

  <div class="paper-count-badge">
    æ”¶å½•è®ºæ–‡æ€»æ•°ï¼š<strong>{{ site.posts.size }}</strong> ç¯‡
  </div>

  <p>åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥æ‰¾åˆ°æ‰€æœ‰è®ºæ–‡çš„å®Œæ•´åˆ†ç±»åˆ—è¡¨ã€‚</p>

  {% include tag-filter.html %}

  <div class="collection-content">
    {% for main_cat_entry in site.data.collection_structure %}
    {% assign main_cat_name = main_cat_entry[0] %}
    {% assign sub_cats = main_cat_entry[1] %}
    <h2 class="main-category-title" id="{{ main_cat_name | slugify }}">{{ main_cat_name | upcase }}</h2>
    {% for sub_cat_entry in sub_cats %}
    {% assign sub_cat_name = sub_cat_entry[0] %}
    {% assign sub_sub_cats = sub_cat_entry[1] %}
    <h3 class="subcategory-title" id="{{ main_cat_name | slugify }}-{{ sub_cat_name | slugify }}">{{ sub_cat_name | capitalize }}</h3>

    <!-- æ£€æŸ¥äºŒçº§åˆ†ç±»æ˜¯å¦æœ‰ç›´æ¥çš„æ–‡ç«  -->
    {% assign has_direct_posts = false %}
    {% for sub_sub_cat_entry in sub_sub_cats %}
      {% assign sub_sub_cat_name = sub_sub_cat_entry[0] %}
      {% assign sub_sub_cat_content = sub_sub_cat_entry[1] %}
      {% if sub_sub_cat_name == 'posts' and sub_sub_cat_content %}
        {% assign has_direct_posts = true %}
        {% assign direct_posts = sub_sub_cat_content %}
        {% break %}
      {% endif %}
    {% endfor %}

    {% if has_direct_posts %}
      <ul class="post-list-with-tags">
      {% assign sorted_posts = direct_posts | sort: "date" %}
      {% for post in sorted_posts reversed %}
      <li class="post-item" data-post-url="{{ site.baseurl }}{{ post.url }}">
        <span class="post-meta">{{ post.date | date: "%Y-%m-%d" }}</span>
        {% if post.tag %}
        <span class="subcategory-tag tag-{{ post.tag | downcase | replace: ' ', '_' | replace: '-', '_' }}">{{ post.tag }}</span>
        {% endif %}
        <a class="post-link" href="{{ site.baseurl }}{{ post.url }}" data-post-title="{{ post.title | escape }}">
          {{ post.title | escape }}
        </a>
      </li>
      {% endfor %}
      </ul>
    {% else %}
      <!-- å¤„ç†ä¸‰çº§å’Œå››çº§åˆ†ç±» -->
      {% for sub_sub_cat_entry in sub_sub_cats %}
      {% assign sub_sub_cat_name = sub_sub_cat_entry[0] %}
      {% assign sub_sub_cat_content = sub_sub_cat_entry[1] %}

      {% if sub_sub_cat_name == 'posts' %}
        <!-- è·³è¿‡postsï¼Œä¸æ˜¾ç¤º -->
      {% elsif sub_sub_cat_content.posts and sub_sub_cat_content.size == 1 %}
        <!-- è¿™æ˜¯çº¯ä¸‰çº§åˆ†ç±»ï¼Œç›´æ¥æ˜¾ç¤ºæ–‡ç«  -->
        <h4 class="sub-subcategory-title" id="{{ main_cat_name | slugify }}-{{ sub_cat_name | slugify }}-{{ sub_sub_cat_name | slugify }}">{{ sub_sub_cat_name | replace: "_", " " | capitalize }}</h4>
        <ul class="post-list-with-tags">
        {% assign sorted_posts_lvl3 = sub_sub_cat_content.posts | sort: "date" %}
        {% for post in sorted_posts_lvl3 reversed %}
        <li class="post-item" data-post-url="{{ site.baseurl }}{{ post.url }}">
          <span class="post-meta">{{ post.date | date: "%Y-%m-%d" }}</span>
          {% if post.tag %}
          <span class="subcategory-tag tag-{{ post.tag | downcase | replace: ' ', '_' | replace: '-', '_' }}">{{ post.tag }}</span>
          {% endif %}
          <a class="post-link" href="{{ site.baseurl }}{{ post.url }}" data-post-title="{{ post.title | escape }}">
            {{ post.title | escape }}
          </a>
        </li>
        {% endfor %}
        </ul>
      {% else %}
        <!-- è¿™æ˜¯å››çº§åˆ†ç±»çš„å®¹å™¨ï¼Œéœ€è¦è¿›ä¸€æ­¥åµŒå¥— -->
        <h4 class="sub-subcategory-title" id="{{ main_cat_name | slugify }}-{{ sub_cat_name | slugify }}-{{ sub_sub_cat_name | slugify }}">{{ sub_sub_cat_name | replace: "_", " " | capitalize }}</h4>
        {% for fourth_level_entry in sub_sub_cat_content %}
          {% assign fourth_level_name = fourth_level_entry[0] %}
          {% assign fourth_level_content = fourth_level_entry[1] %}
          {% if fourth_level_name != 'posts' and fourth_level_content.posts %}
          <h5 class="fourth-level-title" id="{{ main_cat_name | slugify }}-{{ sub_cat_name | slugify }}-{{ sub_sub_cat_name | slugify }}-{{ fourth_level_name | slugify }}">{{ fourth_level_name | replace: "_", " " | capitalize }}</h5>
          <ul class="post-list-with-tags">
          {% assign sorted_posts_lvl4 = fourth_level_content.posts | sort: "date" %}
          {% for post in sorted_posts_lvl4 reversed %}
          <li class="post-item" data-post-url="{{ site.baseurl }}{{ post.url }}">
            <span class="post-meta">{{ post.date | date: "%Y-%m-%d" }}</span>
            {% if post.tag %}
            <span class="subcategory-tag tag-{{ post.tag | downcase | replace: ' ', '_' | replace: '-', '_' }}">{{ post.tag }}</span>
            {% endif %}
            <a class="post-link" href="{{ site.baseurl }}{{ post.url }}" data-post-title="{{ post.title | escape }}">
              {{ post.title | escape }}
            </a>
          </li>
          {% endfor %}
          </ul>
          {% endif %}
        {% endfor %}
        
        <!-- æ˜¾ç¤ºç›´æ¥çš„æ–‡ç« ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ -->
        {% if sub_sub_cat_content.posts %}
        <h5 class="fourth-level-title" id="{{ main_cat_name | slugify }}-{{ sub_cat_name | slugify }}-{{ sub_sub_cat_name | slugify }}-general">General</h5>
        <ul class="post-list-with-tags">
        {% assign sorted_posts_lvl3_general = sub_sub_cat_content.posts | sort: "date" %}
        {% for post in sorted_posts_lvl3_general reversed %}
        <li class="post-item" data-post-url="{{ site.baseurl }}{{ post.url }}">
          <span class="post-meta">{{ post.date | date: "%Y-%m-%d" }}</span>
          {% if post.tag %}
          <span class="subcategory-tag tag-{{ post.tag | downcase | replace: ' ', '_' | replace: '-', '_' }}">{{ post.tag }}</span>
          {% endif %}
          <a class="post-link" href="{{ site.baseurl }}{{ post.url }}" data-post-title="{{ post.title | escape }}">
            {{ post.title | escape }}
          </a>
        </li>
        {% endfor %}
        </ul>
        {% endif %}
      {% endif %}
      {% endfor %}
    {% endif %}

    {% endfor %}
    {% endfor %}
  </div>
</div>

<!-- æ–‡ç« é¢„è§ˆå’ŒæŒ‰éœ€åŠ è½½è„šæœ¬ -->
<script>
class PostPreviewLoader {
  constructor() {
    this.loadedPosts = new Map();
    this.hoverTimeout = null;
    this.hideTimeout = null;
    this.currentHoveredItem = null;
    this.activeFetchController = null;
    this.init();
  }

  init() {
    // ä¸ºæ‰€æœ‰æ–‡ç« é¡¹æ·»åŠ hoveräº‹ä»¶ï¼ˆæ”¹ä¸º mouseoverï¼Œä¾¿äºä½¿ç”¨ relatedTarget åˆ¤æ–­ï¼‰
    document.addEventListener('mouseover', (e) => {
      const postItem = e.target.closest('.post-item');
      if (postItem) {
        // è®¾ç½®å½“å‰hoverçš„é¡¹ç›®
        this.currentHoveredItem = postItem;
        
        // æ¸…é™¤ä¹‹å‰çš„å»¶è¿Ÿ
        if (this.hoverTimeout) {
          clearTimeout(this.hoverTimeout);
        }
        if (this.hideTimeout) {
          clearTimeout(this.hideTimeout);
        }
        
        // å»¶è¿Ÿ300msæ˜¾ç¤ºé¢„è§ˆ
        this.hoverTimeout = setTimeout(() => {
          this.handlePostHover(postItem);
        }, 300);
      }
    }, true);

    // é¼ æ ‡ç¦»å¼€æ–‡ç« é¡¹æ—¶å»¶è¿Ÿéšè—é¢„è§ˆï¼ˆæ”¹ä¸º mouseoutï¼Œé…åˆ relatedTarget åˆ¤æ–­æ˜¯å¦è¿›å…¥äº†é¢„è§ˆé¢æ¿ï¼‰
    document.addEventListener('mouseout', (e) => {
      const postItem = e.target.closest('.post-item');
      if (postItem) {
        // å¦‚æœé¼ æ ‡å®é™…ç§»åŠ¨åˆ°äº†åŒä¸€ postItem å†…éƒ¨çš„é¢„è§ˆé¢æ¿ï¼Œåˆ™ä¸å¤„ç†éšè—
        const related = /** @type {HTMLElement|null} */ (e.relatedTarget);
        if (related && postItem.contains(related)) {
          return;
        }

        // æ¸…é™¤æ˜¾ç¤ºå»¶è¿Ÿ
        if (this.hoverTimeout) {
          clearTimeout(this.hoverTimeout);
        }
        
        // å»¶è¿Ÿ200mséšè—é¢„è§ˆï¼Œç»™ç”¨æˆ·æ—¶é—´ç§»åŠ¨åˆ°é¢„è§ˆçª—å£
        this.hideTimeout = setTimeout(() => {
          this.hidePreview(postItem);
        }, 200);
      }
    }, true);

    // é¼ æ ‡è¿›å…¥é¢„è§ˆçª—å£æ—¶å–æ¶ˆéšè—ï¼ˆmouseover æ›´çµæ•ï¼‰
    document.addEventListener('mouseover', (e) => {
      const previewContainer = e.target.closest('.post-preview');
      if (previewContainer) {
        console.log('é¼ æ ‡è¿›å…¥é¢„è§ˆçª—å£');
        // å–æ¶ˆéšè—å»¶è¿Ÿ
        if (this.hideTimeout) {
          clearTimeout(this.hideTimeout);
        }
        // è®¾ç½®å½“å‰hoverçš„é¡¹ç›®ä¸ºé¢„è§ˆçª—å£å¯¹åº”çš„æ–‡ç« é¡¹
        const postItem = previewContainer.closest('.post-item');
        if (postItem) {
          this.currentHoveredItem = postItem;
        }
      }
    }, true);

    // é¼ æ ‡ç¦»å¼€é¢„è§ˆçª—å£æ—¶å»¶è¿Ÿéšè—ï¼ˆmouseout é…åˆ relatedTarget åˆ¤æ–­æ˜¯å¦å›åˆ°åŒä¸€ postItemï¼‰
    document.addEventListener('mouseout', (e) => {
      const previewContainer = e.target.closest('.post-preview');
      if (previewContainer) {
        const postItem = previewContainer.closest('.post-item');
        if (postItem) {
          const related = /** @type {HTMLElement|null} */ (e.relatedTarget);
          // å¦‚æœé¼ æ ‡å›åˆ° postItem åŒºåŸŸï¼ˆåŒ…æ‹¬æ ‡é¢˜ç­‰ï¼‰ï¼Œåˆ™ä¸éšè—
          if (related && postItem.contains(related)) {
            return;
          }
          // å»¶è¿Ÿ200mséšè—ï¼Œç»™ç”¨æˆ·æ—¶é—´ç§»å›æ–‡ç« é¡¹
          this.hideTimeout = setTimeout(() => {
            // åªæœ‰åœ¨ä¸æ˜¯å½“å‰hoverçš„é¡¹ç›®æ—¶æ‰éšè—
            if (this.currentHoveredItem !== postItem) {
              this.hidePreview(postItem);
            }
          }, 200);
        }
      }
    }, true);
  }

  async handlePostHover(postItem) {
    const postUrl = postItem.dataset.postUrl;
    const postLink = postItem.querySelector('.post-link');
    const postTitle = postLink.dataset.postTitle;
    
    // åˆ›å»ºé¢„è§ˆå®¹å™¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    let previewContainer = postItem.querySelector('.post-preview');
    if (!previewContainer) {
      previewContainer = document.createElement('div');
      previewContainer.className = 'post-preview';
      previewContainer.style.display = 'none';
      postItem.appendChild(previewContainer);
    }
    
    // å¦‚æœå·²ç»åŠ è½½è¿‡ï¼Œç›´æ¥æ˜¾ç¤º
    if (this.loadedPosts.has(postUrl)) {
      this.showPreview(previewContainer, this.loadedPosts.get(postUrl));
      return;
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    this.showLoadingState(previewContainer);

    try {
      // å–æ¶ˆä¸Šä¸€æ¬¡æœªå®Œæˆçš„è¯·æ±‚ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      if (this.activeFetchController && typeof this.activeFetchController.abort === 'function') {
        this.activeFetchController.abort();
      }

      // åˆ›å»ºæ–°çš„è¯·æ±‚æ§åˆ¶å™¨
      this.activeFetchController = (typeof AbortController !== 'undefined') ? new AbortController() : null;
      const signal = this.activeFetchController ? this.activeFetchController.signal : undefined;

      // è·å–æ–‡ç« å†…å®¹
      const response = await fetch(postUrl, { signal });
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const html = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      
      // æå–æ–‡ç« å†…å®¹
      const postContent = doc.querySelector('.post-content');
      if (postContent) {
        // æå–"A1 ä¸»è¦è´¡çŒ®"ç« èŠ‚å†…å®¹
        const contributionSection = this.extractContributionSection(postContent);
        
        // ç¼“å­˜å†…å®¹
        this.loadedPosts.set(postUrl, {
          title: postTitle,
          contribution: contributionSection,
          fullContent: postContent.innerHTML,
          url: postUrl
        });

        // æ˜¾ç¤ºé¢„è§ˆ
        this.showPreview(previewContainer, this.loadedPosts.get(postUrl));
      } else {
        throw new Error('Content not found');
      }

    } catch (error) {
      // å¿½ç•¥ä¸»åŠ¨å–æ¶ˆå¯¼è‡´çš„å¼‚å¸¸
      if (error && (error.name === 'AbortError' || error.message === 'The operation was aborted.')) {
        return;
      }
      console.error('Failed to load post:', error);
      this.showErrorState(previewContainer);
    }
  }

  hidePreview(postItem) {
    const previewContainer = postItem.querySelector('.post-preview');
    if (previewContainer) {
      previewContainer.style.display = 'none';
    }
    // æ¸…ç†å½“å‰hoverçŠ¶æ€
    if (this.currentHoveredItem === postItem) {
      this.currentHoveredItem = null;
    }
  }

  extractContributionSection(postContent) {
    // æŸ¥æ‰¾"A1 ä¸»è¦è´¡çŒ®"ç« èŠ‚
    const headings = postContent.querySelectorAll('h1, h2, h3, h4, h5, h6');
    let contributionSection = null;
    
    for (let heading of headings) {
      const headingText = heading.textContent.trim();
      if (headingText.includes('A1') && headingText.includes('ä¸»è¦è´¡çŒ®')) {
        // æ‰¾åˆ°ç« èŠ‚æ ‡é¢˜ï¼Œæå–åç»­å†…å®¹
        let content = '';
        let nextElement = heading.nextElementSibling;
        
        // æå–ç›´åˆ°ä¸‹ä¸€ä¸ªåŒçº§æˆ–æ›´é«˜çº§æ ‡é¢˜çš„å†…å®¹
        while (nextElement && nextElement.tagName && !nextElement.tagName.match(/^H[1-6]$/)) {
          content += nextElement.textContent + ' ';
          nextElement = nextElement.nextElementSibling;
        }
        
        // å¦‚æœå†…å®¹å¤ªé•¿ï¼Œæˆªå–å‰500ä¸ªå­—ç¬¦
        if (content.length > 500) {
          content = content.substring(0, 500) + '...';
        }
        
        contributionSection = content.trim();
        break;
      }
    }
    
    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°"A1 ä¸»è¦è´¡çŒ®"ï¼Œå°è¯•æŸ¥æ‰¾å…¶ä»–å¯èƒ½çš„è´¡çŒ®ç« èŠ‚
    if (!contributionSection) {
      for (let heading of headings) {
        const headingText = heading.textContent.trim();
        if (headingText.includes('è´¡çŒ®') || headingText.includes('ä¸»è¦') || headingText.includes('åˆ›æ–°')) {
          let content = '';
          let nextElement = heading.nextElementSibling;
          
          while (nextElement && nextElement.tagName && !nextElement.tagName.match(/^H[1-6]$/)) {
            content += nextElement.textContent + ' ';
            nextElement = nextElement.nextElementSibling;
          }
          
          if (content.length > 500) {
            content = content.substring(0, 500) + '...';
          }
          
          contributionSection = content.trim();
          break;
        }
      }
    }
    
    // å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œè¿”å›æ–‡ç« å¼€å¤´çš„å†…å®¹
    if (!contributionSection) {
      const allText = postContent.textContent;
      contributionSection = allText.substring(0, 300) + '...';
    }
    
    return contributionSection;
  }

  showLoadingState(previewContainer) {
    previewContainer.style.display = 'block';
    previewContainer.innerHTML = `
      <div class="preview-content">
        <div class="preview-loading">â³ åŠ è½½ä¸­...</div>
      </div>
    `;
  }

  showPreview(previewContainer, postData) {
    previewContainer.innerHTML = `
      <div class="preview-content">
        <div class="preview-header">
          <h4 class="preview-title">${postData.title}</h4>
        </div>
        <div class="preview-section">
          <h5 class="section-title">ğŸ“‹ ä¸»è¦è´¡çŒ®</h5>
          <div class="preview-contribution">
            ${postData.contribution}
          </div>
        </div>
        <div class="preview-footer">
          <a href="${postData.url}" class="read-full-btn">ğŸ“– é˜…è¯»å®Œæ•´å†…å®¹</a>
        </div>
      </div>
    `;
    previewContainer.style.display = 'block';
  }

  showErrorState(previewContainer) {
    previewContainer.innerHTML = `
      <div class="preview-content">
        <div class="preview-error">
          <p>âŒ åŠ è½½å¤±è´¥</p>
          <button onclick="location.reload()" class="retry-btn">é‡è¯•</button>
        </div>
      </div>
    `;
  }
}

// åˆå§‹åŒ–é¢„è§ˆåŠ è½½å™¨
document.addEventListener('DOMContentLoaded', function() {
  window.postPreviewLoader = new PostPreviewLoader();
});
</script>

<style>
.post-item {
  position: relative;
  transition: all 0.3s ease;
}

.post-item:hover {
  background-color: #f8f9ff;
  border-radius: 4px;
}

/* ç§»é™¤CSS hoveræ§åˆ¶ï¼Œæ”¹ç”¨JavaScriptç²¾ç¡®æ§åˆ¶ */

.post-preview {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #e1e5e9;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  z-index: 1000;
  margin-top: 5px;
  max-width: 600px;
}

.preview-content {
  padding: 20px;
}

.preview-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  border-bottom: 1px solid #e1e5e9;
  padding-bottom: 10px;
}

.preview-title {
  margin: 0;
  font-size: 18px;
  color: #333;
  flex: 1;
}

.preview-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #666;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background-color 0.2s;
}

.preview-close:hover {
  background-color: #f0f0f0;
}

.preview-excerpt {
  color: #666;
  line-height: 1.6;
  margin-bottom: 15px;
}

.preview-footer {
  text-align: center;
}

.read-full-btn {
  display: inline-block;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  text-decoration: none;
  padding: 10px 20px;
  border-radius: 20px;
  font-weight: 600;
  transition: all 0.3s ease;
}

.read-full-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.section-title {
  margin: 0 0 10px 0;
  font-size: 14px;
  color: #667eea;
  font-weight: 600;
  border-bottom: 1px solid #e1e5e9;
  padding-bottom: 5px;
}

.preview-contribution {
  color: #555;
  line-height: 1.6;
  font-size: 14px;
  max-height: 200px;
  overflow-y: auto;
}

.preview-loading {
  text-align: center;
  color: #666;
  font-style: italic;
}

.preview-error {
  text-align: center;
  color: #e53e3e;
}

.retry-btn {
  background: #e53e3e;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  margin-top: 10px;
}

.retry-btn:hover {
  background: #c53030;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .post-preview {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: none;
    max-height: 80vh;
    overflow-y: auto;
  }
  
  .preview-content {
    padding: 15px;
  }
  
  .preview-title {
    font-size: 16px;
  }
}
</style>
