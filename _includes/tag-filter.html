{% comment %}
Tag Filter Component - JavaScript Optimized Version
This component shows tag statistics and provides filtering functionality
Uses JavaScript to dynamically calculate tag counts for better performance
{% endcomment %}

<div class="tag-filter-container">
  <h3 class="tag-filter-title">ğŸ“Š æ ‡ç­¾ç»Ÿè®¡</h3>
  <div class="tag-stats">
    <p>å…±æ‰¾åˆ° <strong id="tag-count">è®¡ç®—ä¸­...</strong> ä¸ªä¸åŒçš„æ ‡ç­¾</p>
  </div>
  
  <div class="tag-filter-buttons">
    <button class="tag-filter-btn tag-filter-all active" data-tag="all">
      å…¨éƒ¨ (<span id="total-posts">{{ site.posts.size }}</span>)
    </button>
    <div id="tag-buttons-container">
      <!-- æ ‡ç­¾æŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // æ”¶é›†æ‰€æœ‰æ–‡ç« æ ‡ç­¾
  const tagMap = new Map();
  const postItems = document.querySelectorAll('.post-item[data-post-url]');
  
  postItems.forEach(item => {
    const tagElement = item.querySelector('.subcategory-tag');
    if (tagElement) {
      const tag = tagElement.textContent.trim();
      tagMap.set(tag, (tagMap.get(tag) || 0) + 1);
    }
  });
  
  // æ›´æ–°æ ‡ç­¾æ•°é‡æ˜¾ç¤º
  document.getElementById('tag-count').textContent = tagMap.size;
  
  // ç”Ÿæˆæ ‡ç­¾æŒ‰é’®
  const container = document.getElementById('tag-buttons-container');
  const sortedTags = Array.from(tagMap.entries()).sort((a, b) => b[1] - a[1]); // æŒ‰æ•°é‡æ’åº
  
  sortedTags.forEach(([tag, count]) => {
    const button = document.createElement('button');
    button.className = 'tag-filter-btn';
    button.setAttribute('data-tag', tag.toLowerCase().replace(/[ -]/g, '_'));
    button.innerHTML = `
      <span class="tag-filter-btn-text">${tag}</span>
      <span class="tag-filter-btn-count">(${count})</span>
    `;
    container.appendChild(button);
  });
  
  // æ·»åŠ æ ‡ç­¾è¿‡æ»¤åŠŸèƒ½
  const tagButtons = document.querySelectorAll('.tag-filter-btn');
  tagButtons.forEach(button => {
    button.addEventListener('click', function() {
      const selectedTag = this.getAttribute('data-tag');
      
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      tagButtons.forEach(btn => btn.classList.remove('active'));
      this.classList.add('active');
      
      // è¿‡æ»¤æ–‡ç« 
      postItems.forEach(item => {
        const tagElement = item.querySelector('.subcategory-tag');
        const itemTag = tagElement ? tagElement.textContent.trim().toLowerCase().replace(/[ -]/g, '_') : '';
        
        if (selectedTag === 'all' || itemTag === selectedTag) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
      
      // æ›´æ–°åˆ†ç±»æ ‡é¢˜æ˜¾ç¤º
      updateCategoryVisibility();
    });
  });
  
  function updateCategoryVisibility() {
    const categories = document.querySelectorAll('.main-category-title, .subcategory-title, .sub-subcategory-title, .fourth-level-title');
    categories.forEach(category => {
      const categoryPosts = category.parentElement.querySelectorAll('.post-item:not([style*="display: none"])');
      if (categoryPosts.length === 0) {
        category.style.display = 'none';
      } else {
        category.style.display = '';
      }
    });
  }
});
</script>
